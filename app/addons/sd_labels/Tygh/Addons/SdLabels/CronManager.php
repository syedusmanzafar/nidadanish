<?php
 declare(strict_types=1); namespace Tygh\Addons\SdLabels; use Tygh\Addons\SdLabels\Labels\Label; use Tygh\Addons\SdLabels\Repositories\LabelRepository; use Tygh\Addons\SdLabels\Repositories\ProductLabelsRepository; use Tygh\Database\Connection; use Tygh\Enum\LabelType; use Tygh\Enum\YesNo; class CronManager { protected $db; protected $settings; protected $productLabelRepository; protected $labelRepository; public function __construct( Connection $db, array $settings, ProductLabelsRepository $productLabelRepository, LabelRepository $labelRepository ) { $this->db = $db; $this->settings = $settings; $this->productLabelRepository = $productLabelRepository; $this->labelRepository = $labelRepository; } public function autoDeleteLabels(): void { $label_collection = $this->labelRepository->getLabelCollection(); foreach ($label_collection as $label) { if ($label->getLabelType() !== LabelType::CUSTOM && method_exists($label, 'cronRemoveLabel')) { $cronData = $label->cronRemoveLabel($this->db, $this->settings); $remove_products = $cronData['remove_products'] ?? []; if (!empty($remove_products)) { $deleted = $this->productLabelRepository->deleteLabelFromProducts( $remove_products, [$label->getLabelId()] ); if ($deleted) { foreach ($remove_products as $product_id) { fn_echo(__($cronData['remove_langvar'], ['[product_id]' => $product_id]) . '<br/>'); } } } } } } public function autoAssignLabels(): void { $label_collection = $this->labelRepository->getLabelCollection(); foreach ($label_collection as $label) { if ($label->getLabelType() !== LabelType::CUSTOM && method_exists($label, 'cronAttachLabel')) { $cronData = $label->cronAttachLabel($this->db, $this->settings); $attach_products = $cronData['attach_products'] ?? []; if (!empty($attach_products)) { foreach ($attach_products as $product_id) { $updated = $this->productLabelRepository->attachLabel( (int)$product_id, $label->getLabelId(), YesNo::NO, true ); if ($updated) { fn_echo(__($cronData['attach_langvar'], ['[product_id]' => $product_id]) . '<br/>'); } } } else { fn_echo(__($cronData['attach_fail_langvar']) . '<br/>'); } } } } } 
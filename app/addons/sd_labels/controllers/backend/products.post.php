<?php
 use Tygh\Addons\SdLabels\Repositories\LabelRepository; defined('BOOTSTRAP') or die('Access denied'); if ($_SERVER['REQUEST_METHOD'] === 'POST') { return [CONTROLLER_STATUS_OK]; } if (in_array($mode, ['manage', 'picker', 'update', 'add', 'm_update'])) { $label_repository = Tygh::$app['addons.sd_labels.label_repository']; } if ($mode === 'manage' || $mode === 'picker') { if (fn_sd_labels_check_availability()) { $selected_fields = Tygh::$app['view']->getTemplateVars('selected_fields'); $selected_fields[] = ['name' => "[data][sd_labels_m]", 'text' => __('sd_labels_m')]; Tygh::$app['view']->assign(compact('selected_fields')); } } elseif ($mode === 'add') { $labels_collection = $label_repository->getLabelCollection(); if (fn_allowed_for('MULTIVENDOR') && ACCOUNT_TYPE === 'vendor') { $labels_collection = $labels_collection->getVendorLabels(); } Tygh::$app['view']->assign([ 'sd_labels' => $labels_collection->toArray(), 'sd_show_labels' => fn_sd_labels_check_availability(), ]); } elseif ($mode === 'update') { $labels_collection = $label_repository->getLabelCollection(); if (fn_allowed_for('MULTIVENDOR') && ACCOUNT_TYPE === 'vendor') { $labels_collection = $labels_collection->getVendorLabels(); } $product_id = $_REQUEST['product_id'] ?? 0; Tygh::$app['view']->assign([ 'sd_labels' => $labels_collection->toArray(), 'sd_show_labels' => fn_sd_labels_check_availability(), 'sd_show_apply_labels_for_variations' => fn_sd_labels_get_product_variation_ids($product_id), ]); } elseif ($mode === 'm_update') { $selected_fields = Tygh::$app['session']['selected_fields']; if (!empty($selected_fields['data']['sd_labels_m'])) { $labels_collection = $label_repository->getLabelCollection() ->getAttachable() ->getActive(); if (fn_allowed_for('MULTIVENDOR') && ACCOUNT_TYPE === 'vendor') { $labels_collection = $labels_collection->getVendorLabels(); } $sd_labels = array_reduce($labels_collection->toArray(), function ($acc, $label) { $acc[$label['label_id']] = ['name' => $label['name'], 'status' => $label['status']]; return $acc; }, []); Tygh::$app['view']->assign(compact('sd_labels')); } } 
<?php
 use Tygh\Registry; use Tygh\Http; use Tygh\Addons\SchemesManager; if (!defined('BOOTSTRAP')) { die('Access denied'); } function fn_sd_bulk_edit_qty_get_product_fields(&$fields) { if ($fields) { $fields[] = array( 'name' => '[data][qty_discounts]', 'text' => __('qty_discounts') ); } } function fn_sd_bulk_edit_qty_get_product_data_post(&$product_data, $auth, $preview, $lang_code) { if ($product_data && !empty($auth['user_id'])) { $runtime = Registry::get('runtime'); if ($runtime['controller'] == 'products' && $runtime['mode'] == 'm_update') { fn_get_product_prices($product_data['product_id'], $product_data, $auth); } } } function fn_sd_bulk_edit_qty_update_product_pre(&$product_data, $product_id, $lang_code, $can_update) { if (!empty($product_data['prices']) && $product_id) { $runtime = Registry::get('runtime'); if ($runtime['controller'] == 'products' && $runtime['mode'] == 'm_override' && !isset($product_data['price'])) { if (fn_allowed_for('ULTIMATE') && $runtime['company_id']) { $table_name = '?:ult_product_prices'; $condition = db_quote(' AND company_id = ?i', $runtime['company_id']); } else { $table_name = '?:product_prices'; $condition = ''; } $product_data['price'] = db_get_field( "SELECT price FROM $table_name " . "WHERE percentage_discount = 0 AND lower_limit = 1 AND usergroup_id = 0 AND product_id = ?i $condition", $product_id ); if (empty($product_data['price']) && fn_allowed_for('ULTIMATE')) { $product_data['price'] = db_get_field( 'SELECT price FROM ?:product_prices ' . 'WHERE percentage_discount = 0 AND lower_limit = 1 ' . 'AND usergroup_id = 0 AND product_id = ?i', $product_id ); } } } } 
<?php
 use Tygh\Registry; use Tygh\Addons\SchemesManager; use Tygh\Http; if (!defined('BOOTSTRAP')) { die('Access denied'); } function fn_sd_menu_update_category_post($category_data, $category_id, $lang_code) { if (!empty($category_id)) { fn_attach_image_pairs('category_item_icon', 'category_icon', $category_id, $lang_code); fn_attach_image_pairs('category_banner_image', 'category_banner', $category_id, $lang_code); } } function fn_sd_menu_get_category_data_post($category_id, $field_list, $get_main_pair, $skip_company_condition, $lang_code, &$category_data) { if ($get_main_pair == true) { $category_data['main_pair_icon'] = fn_get_image_pairs($category_id, 'category_icon', 'M', true, true, $lang_code); $category_data['banner_main_pair_icon'] = fn_get_image_pairs($category_id, 'category_banner', 'M', true, true, $lang_code); } } function fn_sd_menu_delete_category_post($category_id, $recurse, $category_ids) { if (!empty($category_ids)) { foreach ($category_ids as $k => $c_id) { fn_delete_image_pairs($c_id, 'category_icon'); fn_delete_image_pairs($c_id, 'category_banner'); } } } function fn_sd_menu_get_categories_after_sql(&$categories, $params, $join, $condition, $fields, $group_by, $sortings, $sorting, $limit, $lang_code) { if (!empty($categories) && isset($params['amazon_menu'])) { fn_sd_menu_attach_category_icons($categories, $lang_code); fn_sd_menu_attach_category_banners($categories, $lang_code); } } function fn_sd_menu_attach_category_banners(&$categories, $lang_code) { static $categories_with_banners = array(); static $banner_for_categories = array(); if (empty($categories_with_banners)) { $categories_with_banners = db_get_fields( 'SELECT object_id FROM ?:images_links WHERE object_type = ?s', 'category_banner' ); } if (empty($banner_for_categories) && !empty($categories_with_banners)) { $banner_for_categories = fn_get_image_pairs( $categories_with_banners, 'category_banner', 'M', true, true, $lang_code ); } if (!empty($banner_for_categories)) { foreach ($banner_for_categories as $id => $category_banner) { if (!empty($categories[$id])) { $categories[$id]['banner_main_pair_icon'] = reset($category_banner); } } } } function fn_sd_menu_attach_category_icons(&$categories, $lang_code) { static $categories_with_icons = array(); static $icons_for_categories = array(); if (empty($categories_with_icons)) { $categories_with_icons = db_get_fields( 'SELECT object_id FROM ?:images_links WHERE object_type = ?s', 'category_icon' ); } if (empty($icons_for_categories) && !empty($categories_with_icons)) { $icons_for_categories = fn_get_image_pairs( $categories_with_icons, 'category_icon', 'M', true, true, $lang_code ); } if (!empty($icons_for_categories)) { foreach ($icons_for_categories as $id => $category_icon) { if (!empty($categories[$id])) { $categories[$id]['main_pair_icon'] = reset($category_icon); } } } } function fn_sd_menu_get_product_counts_by_category() { $active_statuses = array('A', 'H'); $categories = db_get_fields('SELECT category_id FROM ?:categories WHERE status IN (?a)', $active_statuses); $counts = array(); $params = array(); $params['only_short_fields'] = true; $params['apply_disabled_filters'] = true; $params['extend'][] = 'companies'; if (fn_allowed_for('ULTIMATE')) { $params['extend'][] = 'sharing'; } foreach ($categories as $category) { $params['cid'] = $category; list($products) = fn_get_products($params); $counts[$category] = count($products); } return $counts; } function fn_sd_menu_hide_empty_categories($top_menu) { static $product_counts = null; if (empty($top_menu)) { return array(); } if (is_null($product_counts)) { Registry::registerCache('sd_menu_categories', array('categories', 'products_categories', 'products'), Registry::cacheLevel('user'), true); $product_counts = Registry::get('sd_menu_categories'); if (empty($product_counts)) { $product_counts = fn_sd_menu_get_product_counts_by_category(); Registry::set('sd_menu_categories', $product_counts); } } return array_filter($top_menu, function($item) use ($product_counts) { if ($item['level'] == 0) { if (empty($item['param_3'])) { return $item; } else { list($type) = fn_explode(':', $item['param_3']); if ($type != 'C') { return $item; } } } if (isset($item['subitems'])) { $item['subitems'] = fn_sd_menu_hide_empty_categories($item['subitems']); } $id = str_replace('categories.view?category_id=', '', $item['href']); $product_count = array_key_exists($id, $product_counts) ? $product_counts[$id] : 0; if ($product_count != 0 || !empty($item['subitems'])) { return $item; } return false; }); } function fn_sd_menu_top_menu_form_post(&$top_menu, $level, $active) { $hide_empty_categories = Registry::get('addons.sd_menu.hide_empty_categories'); if ($hide_empty_categories === 'Y') { $top_menu = fn_sd_menu_hide_empty_categories($top_menu); } if (!empty($top_menu)) { $top_menu_ids = array(); foreach ($top_menu as $id => $menu) { $top_menu_ids[] = $menu['param_id']; if (!empty($menu['param_3'])) { list($type, $c_id, $use_name) = fn_explode(':', $menu['param_3']); if ($type === 'C') { $params = array ( 'category_id' => $c_id, 'plain' => true, 'amazon_menu' => true, ); list($_categories, ) = fn_get_categories($params); $categories = array(); foreach ($_categories as $key => $category) { $categories[$category['category_id']] = $category; } if (!empty($categories[$c_id]['label_text']) && empty($top_menu[$id]['label_text'])) { $top_menu[$id]['label_text'] = $categories[$c_id]['label_text']; } if (!empty($categories[$c_id]['label_color']) && empty($top_menu[$id]['label_color'])) { $top_menu[$id]['label_color'] = $categories[$c_id]['label_color']; } if (!empty($categories[$c_id]['banner_url']) && empty($top_menu[$id]['banner_url'])) { $top_menu[$id]['banner_url'] = $categories[$c_id]['banner_url']; } if (!empty($categories[$c_id]['main_pair_icon'])) { $top_menu[$id]['main_pair_icon'] = $categories[$c_id]['main_pair_icon']; } if (!empty($categories[$c_id]['banner_main_pair_icon'])) { $top_menu[$id]['banner_main_pair_icon'] = $categories[$c_id]['banner_main_pair_icon']; } if (!empty($categories)) { list($top_menu, ) = fn_sd_menu_add_amazon_items($top_menu, $categories); } } } } fn_sd_menu_attach_menu_icons($top_menu); fn_sd_menu_attach_menu_banners($top_menu); } } function fn_sd_menu_attach_menu_icons(&$top_menu) { static $menu_with_icons = array(); static $icons_for_menus = array(); if (empty($menu_with_icons)) { $menu_with_icons = db_get_fields( 'SELECT object_id FROM ?:images_links WHERE object_type = ?s', 'menu_icon' ); } if (empty($icons_for_menus) && !empty($menu_with_icons)) { $icons_for_menus = fn_get_image_pairs($menu_with_icons, 'menu_icon', 'M'); } if (!empty($icons_for_menus)) { foreach ($icons_for_menus as $id => $menu_icon) { if (!empty($top_menu[$id])) { $top_menu[$id]['main_pair_icon'] = reset($menu_icon); } } } } function fn_sd_menu_attach_menu_banners(&$top_menu) { static $menu_with_banners = array(); static $banners_for_menus = array(); if (empty($menu_with_banners)) { $menu_with_banners = db_get_fields( 'SELECT object_id FROM ?:images_links WHERE object_type = ?s', 'menu_banner' ); } if (empty($banners_for_menus) && !empty($menu_with_banners)) { $banners_for_menus = fn_get_image_pairs($menu_with_banners, 'menu_banner', 'M'); } if (!empty($banners_for_menus)) { foreach ($banners_for_menus as $id => $menu_banner) { if (!empty($top_menu[$id])) { $top_menu[$id]['banner_main_pair_icon'] = reset($menu_banner); } } } } function fn_sd_menu_add_amazon_items($top_menu, $categories) { if (!empty($top_menu) && $categories) { foreach ($top_menu as $id => $item) { $c_id = str_replace('categories.view?category_id=', '', $item['href']); if (!empty($categories[$c_id]['label_text']) && empty($top_menu[$id]['label_text'])) { $top_menu[$id]['label_text'] = $categories[$c_id]['label_text']; } if (!empty($categories[$c_id]['label_color']) && empty($top_menu[$id]['label_color'])) { $top_menu[$id]['label_color'] = $categories[$c_id]['label_color']; } if (!empty($categories[$c_id]['banner_url']) && empty($top_menu[$id]['banner_url'])) { $top_menu[$id]['banner_url'] = $categories[$c_id]['banner_url']; } if (!empty($categories[$c_id]['main_pair_icon'])) { $top_menu[$id]['main_pair_icon'] = $categories[$c_id]['main_pair_icon']; } if (!empty($categories[$c_id]['banner_main_pair_icon'])) { $top_menu[$id]['banner_main_pair_icon'] = $categories[$c_id]['banner_main_pair_icon']; } if (!empty($item['subitems'])) { list($top_menu[$id]['subitems'], $categories) = fn_sd_menu_add_amazon_items($top_menu[$id]['subitems'], $categories); } } } return !empty($top_menu) ? array($top_menu, $categories) : false; } function fn_sd_menu_get_categories($params, $join, $condition, &$fields, $group_by, $sortings, $lang_code) { if (!empty($params['amazon_menu'])) { $fields[] = '?:category_descriptions.label_text'; $fields[] = '?:category_descriptions.label_color'; $fields[] = '?:category_descriptions.banner_url'; } } function fn_sd_menu_get_static_data($params, &$fields, $condition, $sorting, $lang_code) { if (!empty($params['get_params'])) { $fields[] = '?:static_data_descriptions.label_text'; $fields[] = '?:static_data_descriptions.label_color'; $fields[] = '?:static_data_descriptions.banner_url'; } } function fn_sd_menu_update_static_data($data, $param_id, $condition, $section, $lang_code) { if (!empty($param_id)) { fn_attach_image_pairs('menu_item_icon', 'menu_icon', $param_id, $lang_code); fn_attach_image_pairs('menu_banner_image', 'menu_banner', $param_id, $lang_code); } } function fn_sd_menu_delete_static_data_images($param_id) { if (!empty($param_id)) { fn_delete_image_pairs($param_id, 'menu_icon'); fn_delete_image_pairs($param_id, 'menu_banner'); } } function fn_sd_menu_get_static_data_description($section, $param_id) { $static_data_descr = db_get_row( 'SELECT sd_descr.label_text, sd_descr.label_color, sd_descr.banner_url FROM ?:static_data AS sd' . ' LEFT JOIN ?:static_data_descriptions as sd_descr ON sd.param_id = sd_descr.param_id' . ' AND sd_descr.lang_code = ?s' . ' WHERE sd.section = ?s AND sd.param_id = ?i', DESCR_SL, $section, $param_id ); return $static_data_descr; } 
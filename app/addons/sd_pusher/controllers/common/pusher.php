<?php
 use Tygh\Pusher\Pusher; if (!defined('BOOTSTRAP')) { die('Access denied'); } if ($_SERVER['REQUEST_METHOD'] == 'POST') { if ($mode == 'auth') { if (!empty($_REQUEST['token']) && !empty($_REQUEST['channel_name']) && !empty($_REQUEST['socket_id'])) { $result = ''; if (strpos($_REQUEST['channel_name'], 'presence') !== false && !empty($_REQUEST['user_id'])) { $presence_data = fn_sd_pusher_get_presence_data($_REQUEST['user_id']); $result = Pusher::auth_presence($_REQUEST['channel_name'], $_REQUEST['socket_id'], $_REQUEST['user_id'], $presence_data); } else { $channel = fn_sd_pusher_check_channel($_REQUEST['token'], $_REQUEST['channel_name']); if ($channel) { $result = Pusher::auth($channel, $_REQUEST['socket_id']); } else { fn_sd_pusher_forbidden(); } } fn_echo($result); } else { fn_sd_pusher_forbidden(); } exit; } if ($mode == 'notify') { if (!empty($_REQUEST['message'])) { $params = $_REQUEST; $params['variables'] = !empty($params['variables']) ? $params['variables'] : array(); $params['lang_code'] = !empty($params['lang_code']) ? $params['lang_code'] : CART_LANGUAGE; if (!empty($params['variables']['url'])) { $params['variables']['%url%'] = fn_url($params['variables']['url']); unset($params['variables']['url']); } fn_set_notification( !empty($params['type']) ? $params['type'] : SD_PUSHER_DEFAULT_NOTIFICATION_TYPE, __('sd_pusher.notify.title'), __($params['message'], $params['variables'], $params['lang_code']), !empty($params['message_state']) ? $params['message_state'] : '' ); } exit; } return; } 